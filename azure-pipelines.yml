trigger:
- master
- develop

pool:
  vmImage: 'ubuntu-16.04'

variables:
  GOOGLE_APPLICATION_CREDENTIALS: '' 

steps:
- task: DownloadSecureFile@1
  inputs:
    secureFile: 'azure-gcp.json'
  displayName: 'Download gcp service account file to use for authentication'

- task: KubectlInstaller@0
  inputs:
    kubectlVersion: '1.13.4'

- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: '2.13.1'

- script: |
    export CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)"
    echo "deb http://packages.cloud.google.com/apt $CLOUD_SDK_REPO main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
    sudo apt-get update && sudo apt-get install google-cloud-sdk
    echo "##vso[task.setvariable variable=GOOGLE_APPLICATION_CREDENTIALS]$DOWNLOADSECUREFILE_SECUREFILEPATH"
  displayName: 'Install gcloud'

- script: |
    echo $GOOGLE_APPLICATION_CREDENTIALS
    gcloud auth activate-service-account --key-file=$DOWNLOADSECUREFILE_SECUREFILEPATH
    gcloud config set project focal-freedom-236620
  displayName: 'Initilaize gcloud'

- script: |
    echo 'cred...'
    echo $GOOGLE_APPLICATION_CREDENTIALS
  displayName: 'gcloud creds'

- task: TerraformInstaller@0
  inputs:
    terraformVersion: '0.11.14'
  displayName: 'Install Terraform'

- task: TerraformCLI@0
  inputs:
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
  displayName: 'Terraform Init'

- task: TerraformCLI@0
  inputs:
    command: 'plan'
    commandOptions: '-var-file="vars-dev.tfvars" -auto-approve'
    workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
    environmentServiceName: 'Pay-As-You-Go(04942fd4-70fc-4ee7-bc1e-cd212c57a25e)'
  displayName: 'Terraform Plan'

- task: TerraformCLI@0
  inputs:
    command: 'apply'
    commandOptions: '-var-file="vars-dev.tfvars" -auto-approve'
    workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
    environmentServiceName: 'Pay-As-You-Go(04942fd4-70fc-4ee7-bc1e-cd212c57a25e)'
  displayName: 'Terraform Apply'